# –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è NiFi & Registry: 100% –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –î–µ–ø–ª–æ–π

## üõ† –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ `deploy.env`, —Å–∫—Ä–∏–ø—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ **–±–∞–π—Ç-–≤-–±–∞–π—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω—ã** –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –≤ –±–æ—é —Ñ–∞–π–ª–∞–º –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (`nifi.yaml`, `nifi-registry.yaml`).
2. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å API (API Integrity)**: –ì—Ä—É–ø–ø–∞ API `nifi.kube5s.ru` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–≤ `apiVersion` –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö CRD). –û–Ω–∞ –ù–ï –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–æ–º–µ–Ω–∞ DNS, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫–æ–¥–æ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
3. **–ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥**: –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OIDC, Keycloak, –¥–æ–º–µ–Ω—ã –∏ –≤–µ—Ä—Å–∏–∏ –æ–±—Ä–∞–∑–æ–≤ —Å–æ–±—Ä–∞–Ω—ã –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ `deploy.env`.
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é—Ç —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ `kubectl secret`.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

- `deploy.env`: –í–∞—à–∞ "—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è". –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
- `render.sh`: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä". –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã –≤ –≥–æ—Ç–æ–≤—ã–µ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é YAML-—Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ `dist/`.
- `deploy.sh`: "–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä". –í—ã–ø–æ–ª–Ω—è–µ—Ç `render.sh`, —Å–æ–∑–¥–∞–µ—Ç –Ω—É–∂–Ω—ã–µ Namespace –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã (—Å–Ω–∞—á–∞–ª–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, –∑–∞—Ç–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã).
- `templates/`: "–ó–æ–ª–æ—Ç—ã–µ" –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏ `${VAR}`.

## üìù –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ deploy.env

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `NIFI_DOMAIN` | –¶–µ–ª–µ–≤–æ–π DNS –¥–æ–º–µ–Ω –¥–ª—è NiFi (–Ω–∞–ø—Ä–∏–º–µ—Ä, `nifi.my-org.com`) |
| `REGISTRY_DOMAIN` | –¶–µ–ª–µ–≤–æ–π DNS –¥–æ–º–µ–Ω –¥–ª—è NiFi Registry |
| `KEYCLOAK_URL` | –ë–∞–∑–æ–≤—ã–π URL Keycloak (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://keycloak.k8c.ru`) |
| `KC_REALM` | Realm –≤ Keycloak –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ |
| `SYNC_CLIENT_SECRET` | Client Secret –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Service Account) |
| `OPERATOR_IMAGE` | –û–±—Ä–∞–∑ NiFi Operator |
| `REGISTRY_OPERATOR_IMAGE` | –û–±—Ä–∞–∑ NiFi Registry Operator |

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `deploy.env` –ø–æ–¥ –≤–∞—à–∏ –Ω—É–∂–¥—ã (–¥–æ–º–µ–Ω—ã, —Å–µ–∫—Ä–µ—Ç—ã).
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π:
   ```bash
   ./deploy.sh
   ```

## ü™ú –ü–æ—Ä—è–¥–æ–∫ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (Manual Order)

**–í–ê–ñ–ù–û**: –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ `./render.sh`. –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ñ–∞–π–ª—ã –∏–∑ `templates/` –Ω–∞–ø—Ä—è–º—É—é!

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è**: –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤.
   ```bash
   ./render.sh
   ```
2. **Namespaces**: –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç).
   ```bash
   kubectl create namespace nifi
   kubectl create namespace registry
   ```
3. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Certs)**: –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ CA –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã.
   ```bash
   kubectl apply -f dist/mtls-certs.yaml
   ```
4. **–û–ø–µ—Ä–∞—Ç–æ—Ä—ã (Controllers)**: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
   ```bash
   kubectl apply -f dist/nifi-operator.yaml
   kubectl apply -f dist/registry-operator.yaml
   ```
4. **NiFi Cluster**: –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Ç–µ—Ä.
   ```bash
   kubectl apply -f dist/nifi-cluster.yaml
   ```
5. **NiFi Registry**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ **–ü–û–°–õ–ï** —Ç–æ–≥–æ, –∫–∞–∫ NiFi —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω (–ø–æ—è–≤–∏–ª—Å—è –µ–≥–æ CA —Å–µ–∫—Ä–µ—Ç).
   ```bash
   kubectl apply -f dist/registry-cr.yaml
   ```

### ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **Registry –∑–∞–≤–∏—Å–∏—Ç –æ—Ç NiFi**: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ Registry Operator –∫–æ–ø–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç `nifi-mtls-ca-secret-v2` –∏–∑ namespace `nifi`. –ï—Å–ª–∏ NiFi –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª —ç—Ç–æ—Ç —Å–µ–∫—Ä–µ—Ç, Registry –Ω–µ —Å–º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å TLS.
- **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**: –ï—Å–ª–∏ –≤—ã —É–¥–∞–ª–∏–ª–∏ NiFi –ø–æ–ª–Ω–æ—Å—Ç—å—é (—Å –æ—á–∏—Å—Ç–∫–æ–π —Å–µ–∫—Ä–µ—Ç–æ–≤) –∏–ª–∏ —Å–±—Ä–æ—Å–∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π CA, **Registry –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å**:
  ```bash
  kubectl delete pod -n registry -l app=nifi-registry
  ```
  –≠—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç init-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã Registry, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ—Å–æ–±–µ—Ä—É—Ç TrustStore/KeyStore –Ω–∞ –±–∞–∑–µ –Ω–æ–≤–æ–≥–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ CA –æ—Ç NiFi.

## ÔøΩ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keycloak

–î–ª—è —Ä–∞–±–æ—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (OIDC) –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ Keycloak:

### 1. –ö–ª–∏–µ–Ω—Ç –¥–ª—è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (`nifi-sync-client`)
–≠—Ç–æ—Ç –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ API Keycloak.
- **Access Type**: `confidential` (–∏–ª–∏ Service Accounts Enabled: `on`).
- **Service Account Roles**:
    - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É `Service Account Roles`.
    - –í—ã–±–µ—Ä–∏—Ç–µ –≤ Client Roles: `realm-management`.
    - –î–æ–±–∞–≤—å—Ç–µ —Ä–æ–ª–∏: `view-users`, `query-groups`.
- **Mappers**:
    - –°–æ–∑–¥–∞–π—Ç–µ Mapper —Ç–∏–ø–∞ `Audience`.
    - Name: `realm-management-audience`.
    - Included Client Audience: `realm-management`.
    - *–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ç–æ–∫–µ–Ω –∏–º–µ–ª –ø—Ä–∞–≤–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API Keycloak.*

### 2. –ö–ª–∏–µ–Ω—Ç –¥–ª—è Login (OIDC)
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
- **Redirect URIs**: 
    - `https://nifi.your-domain.com/nifi-api/callback`
    - `https://registry.your-domain.com/nifi-registry-api/callback`
- **Mappers**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `preferred_username` –∏ –≥—Ä—É–ø–ø—ã.

–ë—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ `nifi-sync-client` –¥–æ—Å—Ç—É–ø–µ–Ω –∑–¥–µ—Å—å: [nifi-sync-client-backup.json](./nifi-sync-client-backup.json).

## ÔøΩüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è DevOps (Verification)

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–µ –≤–Ω–µ—Å–ª–∞ "–¥—Ä–µ–±–µ–∑–≥" –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —ç—Ç–∞–ª–æ–Ω–æ–º:
```bash
./render.sh
diff -u ../nifi/nifi.yaml dist/nifi-cluster.yaml
```
–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `deploy.env`, `diff` –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∏—á–∏–π –≤ –ª–æ–≥–∏–∫–µ –∏ –∑–Ω–∞—á–µ–Ω–∏—è—Ö.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
- **Namespaces**: –°–∫—Ä–∏–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω—ç–π–º—Å–ø–µ–π—Å—ã `nifi` –∏ `registry`.
- **Cert-Manager**: –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `cert-manager` –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ `Issuer`.
- **Keycloak**: –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Keycloak —Å–æ–∑–¥–∞–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã. –ë—ç–∫–∞–ø –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ `nifi_manual_deploy/nifi-sync-client-backup.json`.
