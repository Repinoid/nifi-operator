# Apache NiFi Cluster (Custom Resource)
# Operator: nifi-operator
# API Version: nifi.kube5s.ru/v1alpha1

apiVersion: nifi.kube5s.ru/v1alpha1
kind: NifiCluster
metadata:
  name: nificl
  namespace: nifi

spec:
  replicaCount: 1
  image: "${NIFI_IMAGE}"

  downloadFiles:
    - https://jdbc.postgresql.org/download/postgresql-42.7.8.jar

  tlsSecretName: nifi-internal-tls-secret

  auth:
    oidc:
      enabled: true
      realmName: "${KEYCLOAK_REALM}"
      discoveryURL: "${KEYCLOAK_URL}/realms/${KEYCLOAK_REALM}/.well-known/openid-configuration"
      clientID: "${NIFI_OIDC_CLIENT_ID}"
      clientSecret: "${NIFI_OIDC_CLIENT_SECRET}"
      keycloakCert: "keycloak-nifi-secret"

    # --- –°–¢–ê–¢–ò–ß–ï–°–ö–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NiFi –ë–ï–ó —É—á–∞—Å—Ç–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –°–ê–ú–û–ú –ü–ï–†–í–û–ú —Å—Ç–∞—Ä—Ç–µ) ---
    # –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤ authorizers.xml –∏ users.xml.
    # –ï—Å–ª–∏ –Ω–∞ PVC —É–∂–µ –µ—Å—Ç—å —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥–æ–≤, NiFi –ò–ì–ù–û–†–ò–†–£–ï–¢ —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
    adminGroup: "nifi_admins" 
    clientGroup: "nifi_clients"
    tokenClaimName: "nifi_groups"
    initialAdminUser: "${INITIAL_ADMIN}" # preferred_username –∏–∑ Keycloak. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –≥—Ä—É–ø–ø–µ admins.

    # --- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–ü–ï–†–ê–¢–û–†–û–ú —á–µ—Ä–µ–∑ REST API –ø–æ—Å—Ç–æ—è–Ω–Ω–æ) ---
    # –û–ø–µ—Ä–∞—Ç–æ—Ä –±–µ—Ä–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø –∏–∑ Keycloak –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç NiFi.
    sync:
      enabled: true
      intervalSeconds: 300
      clientID: "${SYNC_CLIENT_ID}"
      clientSecret: "${SYNC_CLIENT_SECRET}"

      # üöÄ –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Registry (–ù–æ–≤–∞—è —Ñ–∏—á–∞)
      # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π Users/Groups –∏ –ü–æ–ª–∏—Ç–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ Registry
      registry:
        enabled: true
        url: "https://registry.registry.svc.cluster.local:18443" # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π Service Registry
        insecureSkipVerify: true # –î–ª—è self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

      groups:
        # –í–ê–ñ–ù–û: –ü–µ—Ä–≤–∞—è –≥—Ä—É–ø–ø–∞ –≤ —Å–ø–∏—Å–∫–µ –î–û–õ–ñ–ù–ê –±—ã—Ç—å –∞–¥–º–∏–Ω—Å–∫–æ–π
        - name: "nifi_admins"
          nifiPolicies:
            - resource: "/flow"
              actions: ["read"]
            - resource: "/controller"
              actions: ["read", "write"]
            - resource: "/parameter-contexts"
              actions: ["read", "write"]
            - resource: "/provenance"
              actions: ["read"]
            - resource: "/restricted-components"
              actions: ["read", "write"]
            - resource: "/tenants"
              actions: ["read", "write"]
            - resource: "/policies"
              actions: ["read", "write"]
            - resource: "/proxy"
              actions: ["write"]
            - resource: "/system"
              actions: ["read"]
            - resource: "/counters"
              actions: ["read", "write"]
            - resource: "/data-transfer"
              actions: ["write"]
            - resource: "/process-groups/root"
              actions: ["read", "write"]
          registryPolicies:
            - resource: "/policies"
              actions: ["read", "write"]
            - resource: "/buckets"
              actions: ["read", "write"]

        # –Æ–∑–µ—Ä—Å–∫–∞—è –≥—Ä—É–ø–ø–∞: –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –Ω–µ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ (—Å–µ–±–µ –∏–ª–∏ –¥—Ä—É–≥–∏–º)
        - name: "nifi_clients"
          nifiPolicies:
            - resource: "/flow"
              actions: ["read"]
            - resource: "/process-groups/root"
              actions: ["read", "write"]
          registryPolicies:
            - resource: "/buckets"
              actions: ["read"]

        - name: "test-sync-group"
          nifiPolicies:
            - resource: "/system"
              actions: ["read"]
            - resource: "/tenants"
              actions: ["read"]
          registryPolicies:
            - resource: "/buckets"
              actions: ["read"]
            - resource: "/policies"
              actions: ["read"]

  hostAliases:
    - ip: "10.107.155.29" # ClusterIP –¥–ª—è Registry
      hostnames:
        - "${REGISTRY_DOMAIN}"

  env:
    webHttpsHost: "0.0.0.0"
    webHttpsPort: "8443"
    webProxyHost: "${NIFI_DOMAIN}:443"
    logLevel: "DEBUG"
    securityNeedClientAuth: "false"
    clusterIsNode: "false"
    remoteInputSecure: "true"
    remoteInputSocketPort: "10443"
    webProxyScheme: "https"
    webHttpContextPath: "/nifi"
  
  storage:
    config: { size: "333Mi", storageClass: "local-path" }
    flowFile: { size: "300Mi", storageClass: "local-path" }
    content: { size: "300Mi", storageClass: "local-path" }
    provenance: { size: "300Mi", storageClass: "local-path" }
    database: { size: "300Mi", storageClass: "local-path" }
    logs: { size: "300Mi", storageClass: "local-path" }
  
  # ============================================================================
  # INIT CONTAINER: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º NiFi
  # ============================================================================
  # Init-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏:
  #   - –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  #   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è nifi.properties –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
  #   - –ò–º–ø–æ—Ä—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤ KeyStore/TrustStore
  #   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ authorizers.xml, login-identity-providers.xml
  #   - –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
  # 
  # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: setupNifiProperties/cmd/nifi-setup/setup-nifi.go
  init:
    # –û–ü–ê–°–ù–û! –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    # 
    # true  = –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ Pod –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    #         –ü–û–¢–ï–†–Ø –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ UI:
    #           - –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –≥—Ä—É–ø–ø—ã (users.xml)
    #           - –ù–æ–≤—ã–µ policies (authorizations.xml)
    #           - –†—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ nifi.properties
    # 
    # false = –ö–æ–Ω—Ñ–∏–≥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    #         –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏
    # 
    # –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    #   - true:  –¢–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ development
    #   - false: –í–°–ï–ì–î–ê –≤ production –∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–∏—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    # 
    # –í–ù–ò–ú–ê–ù–ò–ï: –í–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–æ–π –æ–ø—Ü–∏–∏ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ NiFi = –ø–æ—Ç–µ—Ä—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!
    overWrite: false
  
  resources:
    requests: { cpu: "1000m", memory: "2Gi" }
    limits: { cpu: "2000m", memory: "4Gi" }

  serviceAccount:
    secretName: "nificl-sa-cert"
    cN: "nifi-operator-client"    
  
  registryClients: 
    - name: "Naeel Dev0 Registry"
      url: "https://registry.registry.svc.cluster.local:18443"
      ssl:
        keystoreFile: "/opt/nifi/nifi-current/conf/registry-client-keystore.p12"
        keystorePassword: "parole"
        keystoreType: "PKCS12"
        truststoreFile: "/opt/nifi/nifi-current/conf/truststore-custom.jks"
        truststorePassword: "parole"
        truststoreType: "JKS"
        sslProtocol: "TLS"

  ingress:
    enabled: true
    className: "nginx"
    host: "${NIFI_DOMAIN}"
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: HTTPS
      nginx.ingress.kubernetes.io/proxy-body-size: 110m
      nginx.ingress.kubernetes.io/proxy-ssl-verify: "off"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      - hosts: [ "${NIFI_DOMAIN}" ]
        secretName: nifi-tls-secret
