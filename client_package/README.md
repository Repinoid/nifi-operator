# Инструкция по работе

Пакет для управления экземплярами Nubes через Terraform.

## 0. Установка Terraform

Для работы требуется установленная утилита Terraform (версии 1.0 или выше).

1. Скачать дистрибутив для вашей ОС с [официального сайта](https://developer.hashicorp.com/terraform/install).
   * *Альтернативное зеркало (без VPN):* [Yandex Cloud Mirror](https://hashicorp-releases.yandexcloud.net/terraform/).
2. Распаковать архив.
3. Добавить путь к исполняемому файлу (`terraform` или `terraform.exe`) в переменную окружения `PATH`.

*Проверка установки:*
В терминале (PowerShell/CMD/Bash) выполните `terraform -version`. Должна отобразиться версия.

## 1. Получение API токена

Токен (Access Token) необходим для авторизации Terraform.
**Внимание:** Использование значений из Cookies (например, `KEYCLOAK_IDENTITY`) приведет к ошибке 401. Нужен именно JWT Access Token.

**Инструкция по получению:**
1. Зайти в [Личный кабинет Keycloak](https://keycloak.nubes.ru/realms/cloud/account).
2. Открыть DevTools (`F12`), перейти на вкладку **Network** (Сеть).
3. В поле фильтра (Filter) ввести слово `token`.
4. Обновить страницу (`F5`).
5. В списке запросов найти запрос с именем `token` (метод POST).
   *(Адрес: `.../openid-connect/token`)*
6. Кликнуть на этот запрос, открыть вкладку **Response** (Ответ).
7. Скопировать длинную строку из поля `"access_token"`. Значение копировать без кавычек.

## 2. Настройка

Создать файл переменных:
```bash
cp terraform.tfvars.example terraform.tfvars
```

Вставить полученный токен в `terraform.tfvars`:
```hcl
api_token = "ВАШ_ТОКЕН"
```

## 3. Использование

Инициализация проекта (выполняется один раз):
```bash
terraform init
```

Планирование (просмотр будущих изменений):
```bash
terraform plan
```
*Рекомендуется выполнять перед каждым применением, чтобы увидеть, какие ресурсы будут созданы, изменены или удалены.*

Применение конфигурации:
```bash
terraform apply
```

## 4. Изменение ресурсов (Modify)

Terraform отслеживает состояние ресурсов. Чтобы изменить параметр (например, имя или описание):

1. Откройте `resources.tf`.
2. Измените нужное значение.
   ```hcl
   resource "nubes_tubulus_instance" "example" {
     display_name = "Новое Имя Сервера"
     # ...
   }
   ```
3. Выполните:
   ```bash
   terraform apply
   ```
   Terraform покажет изменения (`~ update`) и попросит подтверждение. Введите `yes`.

## 5. Удаление ресурсов (Delete)

Чтобы удалить все ресурсы, описанные в конфигурации:

1. Выполните команду:
   ```bash
   terraform destroy
   ```
2. Проверьте список удаляемых ресурсов (будут помечены красным минусом `-`).
3. Введите `yes` для подтверждения.

## Конфигурация ресурсов

Управление ресурсами производится в файле `resources.tf`.
В файле `main.tf` хранятся только глобальные настройки провайдера, его править не нужно.

Все поддерживаемые параметры описаны в примерах в `resources.tf`.

## 6. Использование AI инструкций

Вы можете описывать конфигурацию ресурсов на естественном языке, используя поле `instruction`. Это позволяет задавать сложные параметры одной строкой.

Пример использования в `resources.tf`:

```hcl
resource "nubes_tubulus_instance" "example" {
  display_name = "AI Server"
  
  # Инструкция на естественном языке
  # Для ресурса Tubulus это управляет временем работы и симуляцией сбоев
  instruction  = "создай сервер, который работает 10 секунд и успешно завершает работу"
}
```

**Важно:** Параметры, заданные явно в конфигурации (например, `duration_ms = 5000`), имеют приоритет над значениями, полученными из `instruction`.
