apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: nifiregistries.nifi.kube5s.ru
spec:
  group: nifi.kube5s.ru
  names:
    kind: NifiRegistry
    listKind: NifiRegistryList
    plural: nifiregistries
    singular: nifiregistry
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: NifiRegistry is the Schema for the nifiregistries API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: NifiRegistrySpec defines the desired state of NifiRegistry
            properties:
              database:
                description: Database configuration (not used yet, prepared for future)
                properties:
                  databaseName:
                    type: string
                  deployPostgres:
                    type: boolean
                  enabled:
                    type: boolean
                  host:
                    type: string
                  password:
                    type: string
                  port:
                    format: int32
                    type: integer
                  username:
                    type: string
                type: object
              downloadFiles:
                description: DownloadFiles - список файлов для загрузки (например,
                  JDBC драйверы)
                items:
                  description: DownloadFile defines file to download
                  properties:
                    destination:
                      type: string
                    url:
                      type: string
                  required:
                  - destination
                  - url
                  type: object
                type: array
              image:
                description: 'Image - Docker образ NiFi Registry (по умолчанию: "apache/nifi-registry:2.6.0")'
                type: string
              images:
                description: Images - образы для всех контейнеров
                properties:
                  alpine:
                    description: 'Alpine - образ Alpine Linux для утилит (по умолчанию:
                      "alpine:3.18")'
                    type: string
                  jre:
                    description: 'JRE - образ Java Runtime для init контейнеров (по
                      умолчанию: "eclipse-temurin:11-jre-alpine")'
                    type: string
                  postgres:
                    description: 'Postgres - образ PostgreSQL (по умолчанию: "postgres:15-alpine")'
                    type: string
                  registry:
                    description: 'Registry - образ NiFi Registry (по умолчанию: "apache/nifi-registry:2.6.0")'
                    type: string
                type: object
              logLevel:
                default: INFO
                description: |-
                  LogLevel - уровень логирования для NiFi Registry (DEBUG, INFO, WARN, ERROR)
                  По умолчанию: INFO
                enum:
                - TRACE
                - DEBUG
                - INFO
                - WARN
                - ERROR
                type: string
              oidc:
                description: OIDC authentication configuration (Keycloak)
                properties:
                  additionalScopes:
                    description: AdditionalScopes - дополнительные OIDC scopes (например,
                      "openid,profile,email")
                    type: string
                  adminGroup:
                    description: |-
                      AdminGroup - группа администраторов из OIDC token claim (например, "nifi_admins")
                      Все пользователи в этой группе получат полные права администратора
                    type: string
                  adminIdentity:
                    description: |-
                      AdminIdentity - DN или username первого администратора (например, admin@example.com)
                      Этот пользователь получит полные права при первом запуске
                    type: string
                  claimGroups:
                    description: ClaimGroups - claim для групп пользователя (например,
                      "groups" или "roles")
                    type: string
                  claimIdentifyingUser:
                    description: 'ClaimIdentifyingUser - claim для идентификации пользователя
                      (по умолчанию: preferred_username)'
                    type: string
                  clientID:
                    description: ClientID - OIDC client ID
                    type: string
                  clientSecret:
                    description: ClientSecret - OIDC client secret
                    type: string
                  discoveryURL:
                    description: DiscoveryURL - OIDC discovery URL (например, https://keycloak.example.com/realms/nifi/.well-known/openid-configuration)
                    type: string
                  enabled:
                    description: Enabled - включить OIDC аутентификацию
                    type: boolean
                  logoutURL:
                    description: |-
                      LogoutURL - URL для выхода из OIDC сессии (опционально)
                      Если не указан, формируется автоматически на основе agreement c Keycloak
                    type: string
                type: object
              overWriteConfig:
                description: OverWriteConfig - перезаписывать конфиги при перезапуске
                  (для отладки)
                type: boolean
              replicaCount:
                default: 1
                description: ReplicaCount - количество реплик Registry
                format: int32
                minimum: 0
                type: integer
              resources:
                description: Resources - CPU/Memory ресурсы для Registry контейнера
                properties:
                  limits:
                    description: ResourceList defines resource quantities
                    properties:
                      cpu:
                        type: string
                      memory:
                        type: string
                    type: object
                  requests:
                    description: ResourceList defines resource quantities
                    properties:
                      cpu:
                        type: string
                      memory:
                        type: string
                    type: object
                type: object
              security:
                description: Security - TLS/mTLS конфигурация
                properties:
                  initialAdminIdentity:
                    description: |-
                      InitialAdminIdentity - DN или username первичного администратора (например, "CN=nifi.kube5s.ru")
                      Если не указан, используется дефолтный (см. CRD description)
                    type: string
                  initialAdminUser:
                    description: |-
                      InitialAdminUser - Локальный пользователь-администратор (например, "regadmin")
                      Будет создан в users.xml и включен в группу администраторов.
                      По умолчанию: "regadmin"
                    type: string
                  keyPassword:
                    description: 'KeyPassword - пароль для private key в KeyStore
                      (по умолчанию: "parole")'
                    type: string
                  keystorePassword:
                    description: 'KeystorePassword - пароль для Java KeyStore (по
                      умолчанию: "parole")'
                    type: string
                  needClientAuth:
                    default: false
                    description: |-
                      NeedClientAuth - требовать клиентский сертификат (mutual TLS)
                      true = клиенты ДОЛЖНЫ предоставить валидный X.509 сертификат
                      false = только server-side TLS (по умолчанию: false)
                    type: boolean
                  nifiControllerIdentity:
                    description: NifiControllerIdentity - Identity сертификата NiFi
                      Operator для операций (например, "CN=nifi-operator-client")
                    type: string
                  nifiIdentity:
                    description: |-
                      NifiIdentity - Identity сертификата NiFi Cluster для mTLS (например, "CN=nifi.kube5s.ru")
                      Используется для grant access cluster-to-registry
                    type: string
                  nifiNamespace:
                    description: |-
                      NifiNamespace - Namespace, где развернут NiFi Cluster и где лежит CA Secret (nifi-mtls-ca-secret).
                      Оператор Registry будет пытаться скопировать CA сертификат из этого namespace.
                      По умолчанию: "nifi".
                      Если ваши NiFi и Registry в разных namespace, укажите здесь namespace NiFi.
                    type: string
                  truststorePassword:
                    description: 'TruststorePassword - пароль для Java TrustStore
                      (по умолчанию: "parole")'
                    type: string
                type: object
              securityContext:
                description: |-
                  SecurityContext - контекст безопасности для пода и контейнеров
                  Позволяет настроить runAsUser, fsGroup и т.д.
                properties:
                  fsGroup:
                    description: |-
                      A special supplemental group that applies to all containers in a pod.
                      Some volume types allow the Kubelet to change the ownership of that volume
                      to be owned by the pod:

                      1. The owning GID will be the FSGroup
                      2. The setgid bit is set (new files created in the volume will be owned by FSGroup)
                      3. The permission bits are OR'd with rw-rw----

                      If unset, the Kubelet will not modify the ownership and permissions of any volume.
                      Note that this field cannot be set when spec.os.name is windows.
                    format: int64
                    type: integer
                  fsGroupChangePolicy:
                    description: |-
                      fsGroupChangePolicy defines behavior of changing ownership and permission of the volume
                      before being exposed inside Pod. This field will only apply to
                      volume types which support fsGroup based ownership(and permissions).
                      It will have no effect on ephemeral volume types such as: secret, configmaps
                      and emptydir.
                      Valid values are "OnRootMismatch" and "Always". If not specified, "Always" is used.
                      Note that this field cannot be set when spec.os.name is windows.
                    type: string
                  runAsGroup:
                    description: |-
                      The GID to run the entrypoint of the container process.
                      Uses runtime default if unset.
                      May also be set in SecurityContext.  If set in both SecurityContext and
                      PodSecurityContext, the value specified in SecurityContext takes precedence
                      for that container.
                      Note that this field cannot be set when spec.os.name is windows.
                    format: int64
                    type: integer
                  runAsNonRoot:
                    description: |-
                      Indicates that the container must run as a non-root user.
                      If true, the Kubelet will validate the image at runtime to ensure that it
                      does not run as UID 0 (root) and fail to start the container if it does.
                      If unset or false, no such validation will be performed.
                      May also be set in SecurityContext.  If set in both SecurityContext and
                      PodSecurityContext, the value specified in SecurityContext takes precedence.
                    type: boolean
                  runAsUser:
                    description: |-
                      The UID to run the entrypoint of the container process.
                      Defaults to user specified in image metadata if unspecified.
                      May also be set in SecurityContext.  If set in both SecurityContext and
                      PodSecurityContext, the value specified in SecurityContext takes precedence
                      for that container.
                      Note that this field cannot be set when spec.os.name is windows.
                    format: int64
                    type: integer
                  seLinuxOptions:
                    description: |-
                      The SELinux context to be applied to all containers.
                      If unspecified, the container runtime will allocate a random SELinux context for each
                      container.  May also be set in SecurityContext.  If set in
                      both SecurityContext and PodSecurityContext, the value specified in SecurityContext
                      takes precedence for that container.
                      Note that this field cannot be set when spec.os.name is windows.
                    properties:
                      level:
                        description: Level is SELinux level label that applies to
                          the container.
                        type: string
                      role:
                        description: Role is a SELinux role label that applies to
                          the container.
                        type: string
                      type:
                        description: Type is a SELinux type label that applies to
                          the container.
                        type: string
                      user:
                        description: User is a SELinux user label that applies to
                          the container.
                        type: string
                    type: object
                  seccompProfile:
                    description: |-
                      The seccomp options to use by the containers in this pod.
                      Note that this field cannot be set when spec.os.name is windows.
                    properties:
                      localhostProfile:
                        description: |-
                          localhostProfile indicates a profile defined in a file on the node should be used.
                          The profile must be preconfigured on the node to work.
                          Must be a descending path, relative to the kubelet's configured seccomp profile location.
                          Must only be set if type is "Localhost".
                        type: string
                      type:
                        description: |-
                          type indicates which kind of seccomp profile will be applied.
                          Valid options are:

                          Localhost - a profile defined in a file on the node should be used.
                          RuntimeDefault - the container runtime default profile should be used.
                          Unconfined - no profile should be applied.
                        type: string
                    required:
                    - type
                    type: object
                  supplementalGroups:
                    description: |-
                      A list of groups applied to the first process run in each container, in addition
                      to the container's primary GID, the fsGroup (if specified), and group memberships
                      defined in the container image for the uid of the container process. If unspecified,
                      no additional groups are added to any container. Note that group memberships
                      defined in the container image for the uid of the container process are still effective,
                      even if they are not included in this list.
                      Note that this field cannot be set when spec.os.name is windows.
                    items:
                      format: int64
                      type: integer
                    type: array
                  sysctls:
                    description: |-
                      Sysctls hold a list of namespaced sysctls used for the pod. Pods with unsupported
                      sysctls (by the container runtime) might fail to launch.
                      Note that this field cannot be set when spec.os.name is windows.
                    items:
                      description: Sysctl defines a kernel parameter to be set
                      properties:
                        name:
                          description: Name of a property to set
                          type: string
                        value:
                          description: Value of a property to set
                          type: string
                      required:
                      - name
                      - value
                      type: object
                    type: array
                  windowsOptions:
                    description: |-
                      The Windows specific settings applied to all containers.
                      If unspecified, the options within a container's SecurityContext will be used.
                      If set in both SecurityContext and PodSecurityContext, the value specified in SecurityContext takes precedence.
                      Note that this field cannot be set when spec.os.name is linux.
                    properties:
                      gmsaCredentialSpec:
                        description: |-
                          GMSACredentialSpec is where the GMSA admission webhook
                          (https://github.com/kubernetes-sigs/windows-gmsa) inlines the contents of the
                          GMSA credential spec named by the GMSACredentialSpecName field.
                        type: string
                      gmsaCredentialSpecName:
                        description: GMSACredentialSpecName is the name of the GMSA
                          credential spec to use.
                        type: string
                      hostProcess:
                        description: |-
                          HostProcess determines if a container should be run as a 'Host Process' container.
                          This field is alpha-level and will only be honored by components that enable the
                          WindowsHostProcessContainers feature flag. Setting this field without the feature
                          flag will result in errors when validating the Pod. All of a Pod's containers must
                          have the same effective HostProcess value (it is not allowed to have a mix of HostProcess
                          containers and non-HostProcess containers).  In addition, if HostProcess is true
                          then HostNetwork must also be set to true.
                        type: boolean
                      runAsUserName:
                        description: |-
                          The UserName in Windows to run the entrypoint of the container process.
                          Defaults to the user specified in image metadata if unspecified.
                          May also be set in PodSecurityContext. If set in both SecurityContext and
                          PodSecurityContext, the value specified in SecurityContext takes precedence.
                        type: string
                    type: object
                type: object
              storage:
                description: Storage - конфигурация PVC для Registry и PostgreSQL
                properties:
                  config:
                    description: Config - PVC для конфигурационных файлов Registry
                    properties:
                      size:
                        description: Size - размер PVC (например, "200Mi", "1Gi")
                        type: string
                      storageClass:
                        description: StorageClassName - класс хранилища (nil = default
                          StorageClass)
                        type: string
                    type: object
                  database:
                    description: Database - PVC для PostgreSQL данных
                    properties:
                      size:
                        description: Size - размер PVC (например, "200Mi", "1Gi")
                        type: string
                      storageClass:
                        description: StorageClassName - класс хранилища (nil = default
                          StorageClass)
                        type: string
                    type: object
                type: object
              web:
                description: Web - конфигурация web сервера
                properties:
                  httpsHost:
                    description: 'HttpsHost - hostname для HTTPS (по умолчанию: "0.0.0.0")'
                    type: string
                  httpsPort:
                    default: 18443
                    description: 'HttpsPort - порт для HTTPS (по умолчанию: 18443)'
                    format: int32
                    maximum: 65535
                    minimum: 1
                    type: integer
                type: object
            type: object
          status:
            description: NifiRegistryStatus defines the observed state of NifiRegistry
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: controller-manager
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: serviceaccount
    app.kubernetes.io/part-of: registry
  name: oper-registry-controller-manager
  namespace: registry
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: leader-election-role
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: role
    app.kubernetes.io/part-of: registry
  name: oper-registry-leader-election-role
  namespace: registry
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: oper-registry-manager-role
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  - persistentvolumeclaims
  - secrets
  - services
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.kube5s.ru
  resources:
  - nifiregistries
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - nifi.kube5s.ru
  resources:
  - nifiregistries/finalizers
  verbs:
  - update
- apiGroups:
  - nifi.kube5s.ru
  resources:
  - nifiregistries/status
  verbs:
  - get
  - patch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: metrics-reader
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrole
    app.kubernetes.io/part-of: registry
  name: oper-registry-metrics-reader
rules:
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: proxy-role
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrole
    app.kubernetes.io/part-of: registry
  name: oper-registry-proxy-role
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: leader-election-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: rolebinding
    app.kubernetes.io/part-of: registry
  name: oper-registry-leader-election-rolebinding
  namespace: registry
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: oper-registry-leader-election-role
subjects:
- kind: ServiceAccount
  name: oper-registry-controller-manager
  namespace: registry
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: rbac
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: manager-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrolebinding
    app.kubernetes.io/part-of: registry
  name: oper-registry-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: oper-registry-manager-role
subjects:
- kind: ServiceAccount
  name: oper-registry-controller-manager
  namespace: registry
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: proxy-rolebinding
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: clusterrolebinding
    app.kubernetes.io/part-of: registry
  name: oper-registry-proxy-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: oper-registry-proxy-role
subjects:
- kind: ServiceAccount
  name: oper-registry-controller-manager
  namespace: registry
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: kube-rbac-proxy
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: controller-manager-metrics-service
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: service
    app.kubernetes.io/part-of: registry
    control-plane: controller-manager
  name: oper-registry-controller-manager-metrics-service
  namespace: registry
spec:
  ports:
  - name: https
    port: 8443
    protocol: TCP
    targetPort: https
  selector:
    control-plane: controller-manager
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: manager
    app.kubernetes.io/created-by: registry
    app.kubernetes.io/instance: controller-manager
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: deployment
    app.kubernetes.io/part-of: registry
    control-plane: controller-manager
  name: oper-registry-controller-manager
  namespace: registry
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: manager
      labels:
        control-plane: controller-manager
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - amd64
                - arm64
                - ppc64le
                - s390x
              - key: kubernetes.io/os
                operator: In
                values:
                - linux
      containers:
      - args:
        - --secure-listen-address=0.0.0.0:8443
        - --upstream=http://127.0.0.1:8080/
        - --logtostderr=true
        - --v=0
        image: gcr.io/kubebuilder/kube-rbac-proxy:v0.13.1
        name: kube-rbac-proxy
        ports:
        - containerPort: 8443
          name: https
          protocol: TCP
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 5m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      - args:
        - --health-probe-bind-address=:8081
        - --metrics-bind-address=127.0.0.1:8080
        - --leader-elect
        command:
        - /manager
        image: naeel/nifi-registry-operator:v2.12.9
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        name: manager
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      securityContext:
        runAsNonRoot: true
      serviceAccountName: oper-registry-controller-manager
      terminationGracePeriodSeconds: 10
