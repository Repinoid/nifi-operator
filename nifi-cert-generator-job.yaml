apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-manager
  namespace: nifi
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: default-secret-access
  namespace: nifi
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-manager
subjects:
- kind: ServiceAccount
  name: default
  namespace: nifi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: nifi-cert-generator
  namespace: nifi
spec:
  completions: 1
  backoffLimit: 0
  template:
    spec:
      containers:
      - name: cert-generator
        image: alpine:latest  # ‚Üê –ú–ï–ù–Ø–ï–ú –ù–ê ALPINE
        command: ["/bin/sh"]
        args:
        - -c
        - |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º openssl –∏ kubectl
          apk add --no-cache openssl curl
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && mv kubectl /usr/local/bin/
          
          echo "üîê –°–æ–∑–¥–∞—ë–º –∫–æ—Ä–Ω–µ–≤–æ–π CA 'My-NiFi-Client-CA'..."
          openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
            -keyout /tmp/ca.key -out /tmp/ca.crt \
            -subj "/CN=My-NiFi-Client-CA" \
            -addext "basicConstraints=critical,CA:TRUE"
          
          echo "üë§ –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç 'nifi-operator-client'..."
          openssl req -newkey rsa:4096 -nodes -keyout /tmp/client.key \
            -out /tmp/client.csr \
            -subj "/CN=nifi-operator-client"
          
          openssl x509 -req -in /tmp/client.csr -CA /tmp/ca.crt -CAkey /tmp/ca.key \
            -CAcreateserial -out /tmp/client.crt -days 365 \
            -sha256 -copy_extensions copyall
          
          echo "üîó –°–æ–∑–¥–∞—ë–º –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
          cat /tmp/client.crt /tmp/ca.crt > /tmp/full-chain.pem
          
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ø–æ—á–∫—É..."
          if openssl verify -CAfile /tmp/ca.crt /tmp/client.crt; then
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞"
            
            echo "üíæ –°–æ–∑–¥–∞—ë–º —Å–µ–∫—Ä–µ—Ç —Å –∫–æ—Ä–Ω–µ–≤—ã–º CA..."
            kubectl create secret generic nifi-mtls-ca-secret \
              --from-file=ca.crt=/tmp/ca.crt \
              --dry-run=client -o yaml | kubectl apply -f -
            
            echo "üíæ –°–æ–∑–¥–∞—ë–º —Å–µ–∫—Ä–µ—Ç —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º..."
            kubectl create secret tls nificl-sa-cert \
              --cert=/tmp/full-chain.pem \
              --key=/tmp/client.key \
              --dry-run=client -o yaml | kubectl apply -f -
            
            echo "üéâ –í–°–Å –ì–û–¢–û–í–û! –°–µ–∫—Ä–µ—Ç—ã —Å–æ–∑–¥–∞–Ω—ã."
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞"
            exit 1
          fi
        env:
        - name: KUBECONFIG
          value: "/var/run/secrets/kubernetes.io/serviceaccount/.kube/config"
        volumeMounts:
        - name: serviceaccount
          mountPath: "/var/run/secrets/kubernetes.io/serviceaccount"
          readOnly: true
      serviceAccountName: default
      automountServiceAccountToken: true
      restartPolicy: Never
      volumes:
      - name: serviceaccount
        projected:
          sources:
          - serviceAccountToken:
              expirationSeconds: 3600
              path: token
          - configMap:
              name: kube-root-ca.crt
              items:
              - key: ca.crt
                path: ca.crt
          - downwardAPI:
              items:
              - path: namespace
                fieldRef:
                  fieldPath: metadata.namespace