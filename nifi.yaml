# kube5s/kube.yaml
# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã nifiServiceUrl –∏ proxyHost –≤ —Å–µ–∫—Ü–∏—é adminGateway
# –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ admin-gateway –∏–∑ CRD

apiVersion: nifi.kube5s.ru/v1alpha1
kind: NifiCluster
metadata:
  name: nificl        # pod name will be nificl-0
  namespace: nifi
spec:
  # –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ä–µ–ø–ª–∏–∫–∞ allowed
  replicaCount: 1
  image: "apache/nifi:2.6.0"

  # üî• DOWNLOAD FILES: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ JAR –±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ /opt/nifi/nifi-current/lib/
  # –õ–æ–≥ init-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ download-files - kubectl logs nificl-0 -c download-files -n nifi
  # 
  # —Å–ø–∏—Å–æ–∫ JAR  -  kubectl exec -it nificl-0 -- ls -l /opt/nifi/nifi-current/lib/
  downloadFiles:
    - https://jdbc.postgresql.org/download/postgresql-42.7.8.jar
    # - https://repo1.maven.org/maven2/org/apache/kafka/kafka-clients/3.6.1/kafka-clients-3.6.1.jar


  auth:
    oidc:
      enabled: true
      realmName: "nifi-realm"
      # –ó–¥–µ—Å—å KEYCLOAK.DOMEN.RU - URL –∫–µ–π–∫–ª–æ–∫–∞, –∏–º—è —Ä–µ–∞–ª–º–∞ nifi-realm
      discoveryURL: "https://KEYCLOAK.DOMEN.RU/realms/nifi-realm/.well-known/openid-configuration" # ***
      clientID: "nifi-keycloak-client"
      clientSecret: "YpsjYPw3l9iFNCZc........."  # *** –≠—Ç–æ –∏–∑ keycloak,  Clients-nifi-keycloak-client-Credentials
      keycloakCert: "keycloak-nifi-secret"
      
    clientGroup:  "nifi_clients"
    adminGroup:   "nifi_admins"
    # take from KeyCloak - Clients - Client details - Dedicated scopes - Mapper details - Token Claim Name
    tokenClaimName: "nifi_groups"
    
  env:
    webHttpsHost: "0.0.0.0"
    webHttpsPort: "8443"
    webProxyHost: "NIFI.DOMEN.RU:443" # ***
    logLevel: "DEBUG"
    securityNeedClientAuth: "false"
    clusterIsNode: "false"
    remoteInputSecure: "true"
    remoteInputSocketPort: "10443"
    webProxyScheme: "https"
    webHttpContextPath: "/nifi"
  
  # vcd-disk-ext4 —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω
  storage:
    config:
      size: "333Mi"
      storageClass: "local-path"
    flowFile:
      size: "300Mi"
      storageClass: "local-path"
    content:
      size: "300Mi"
      storageClass: "local-path"
    provenance:
      size: "300Mi"
      storageClass: "local-path"
    database:
      size: "300Mi"
      storageClass: "local-path"
    logs:
      size: "300Mi"
      storageClass: "local-path"
  
  init:
    initImage: "naeel/nifi-setup:v0.1.24"
    # UWAGA - overWrite –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –µ—Å–ª–∏ true - –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ, 
    # –ø–æ—Ç–µ—Ä–µ–≤ –Ω–æ–≤—ã—Ö —é–∑–µ—Ä–æ–≤ –≥—Ä—É–ø–ø—ã –ø—Ä–∞–≤–∞ –∏ —Ç–¥
    overWrite: true
  
  resources:
    requests:
      cpu: "1000m"
      memory: "2Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"

  serviceAccount:
    secretName: "nificl-sa-cert"
    cN: "nifi-operator-client"    
  
  
  # ADMIN GATEWAY - –¥–æ—Å—Ç—É–ø –∫ Nifi API
  adminGateway:
    enabled: true
    image: "naeel/nifi-admin-gateway:https-v8"
    serviceType: "ClusterIP"
    
    # –ù–û–í–´–ï –ü–ê–†–ê–ú–ï–¢–†–´: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è admin-gateway
    # nifiServiceUrl: "https://nificl.nifi:8443"
    nifiServiceUrl: "https://nificl.nifi.svc.cluster.local:8443"  # ‚Üê –ü–û–õ–ù–û–ï DNS –∏–º—è
    proxyHost: "NIFI.DOMEN.RU:8443" # ***
    
    tls:
      secretName: "nifi-admin-gateway-tls-secret"
    
    ingress:
      enabled: true
      host: "API.DOMEN.RU" # ***
      className: "nginx"
      path: "/nifi-api/"
    
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
  
  ingress:
    enabled: true
    className: "nginx"
    host: "NIFI.DOMEN.RU" # ***
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: HTTPS
      nginx.ingress.kubernetes.io/proxy-body-size: 110m
      nginx.ingress.kubernetes.io/proxy-ssl-verify: "off"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      - hosts:
          - NIFI.DOMEN.RU # ***
        secretName: nifi-tls-secret
